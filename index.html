<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>Inovera Creation - Ultimate Billing System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary: #f28c28; --bg: #fffbf5; --red: #d32f2f; --green: #27ae60; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #e0e0e0; padding: 20px; }
        .top-search-bar { max-width: 850px; margin: 0 auto 15px; background: #333; color: white; padding: 15px; border-radius: 8px; text-align: center; }
        #main-search { width: 60%; padding: 10px; border-radius: 5px; border: none; }
        .controls { max-width: 850px; margin: 0 auto 20px; background: white; padding: 15px; border-radius: 8px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .invoice-container { max-width: 800px; margin: auto; background: white; padding: 40px; min-height: 1050px; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.2); box-sizing: border-box; }
        .page-break { page-break-before: always; margin-top: 50px; border-top: 2px dashed #ccc; padding-top: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #logo-preview { max-width: 150px; cursor: pointer; border: 1px dashed #ccc; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        th, td { border: 1px solid var(--primary); padding: 8px; font-size: 14px; }
        th { background: var(--bg); }
        input, textarea, select { width: 100%; border: none; outline: none; background: transparent; font-family: inherit; }
        #c-name { font-weight: bold; font-size: 1.1em; }
        #seal-container { position: absolute; width: 120px; cursor: move; z-index: 100; top: 800px; left: 600px; user-select: none; }
        #seal-img { width: 100%; opacity: 0.8; }
        #search-results { position: absolute; width: 600px; background: white; z-index: 1000; box-shadow: 0 10px 20px rgba(0,0,0,0.3); left: 50%; transform: translateX(-50%); }
        .search-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; color: black; text-align: left; }
        button { padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; color: white; font-weight: bold; }
        @media print { .no-print, .top-search-bar, .controls { display: none !important; } .invoice-container { box-shadow: none; width: 100%; padding: 20px; } }
    </style>
</head>
<body>

    <div class="top-search-bar no-print">
        <input type="text" id="main-search" placeholder="Search by Client Name or Bill No..." onkeyup="globalSearch()">
        <div id="search-results"></div>
    </div>

    <div class="controls no-print">
        <button onclick="document.getElementById('logo-input').click()" style="background:#555;">Logo</button>
        <button onclick="document.getElementById('seal-input').click()" style="background:#777;">Seal</button>
        <button onclick="addRow()" style="background:var(--green);">+ Item</button>
        <button onclick="saveInvoice()" style="background:#3498db;">Save Online</button>
        <button onclick="exportPDF()" style="background:#9b59b6;">Download PDF</button>
        <button onclick="location.reload()" style="background:var(--red);">Reset</button>
        <input type="file" id="logo-input" accept="image/*" style="display:none">
        <input type="file" id="seal-input" accept="image/*" style="display:none">
    </div>

    <div class="invoice-container" id="printable-area">
        <div class="header">
            <h1 style="font-size: 40px; margin:0;">INVOICE</h1>
            <img id="logo-preview" src="https://via.placeholder.com/150x50?text=Logo">
        </div>
        <div id="seal-container">
            <img id="seal-img" src="https://via.placeholder.com/120x120?text=Digital+Seal">
        </div>

        <div style="display: flex; justify-content: space-between; background: var(--bg); padding: 10px; margin-bottom: 20px; border-top: 3px solid var(--primary);">
            <div><strong>Inv No:</strong> <input type="text" id="inv-no" value="IC-2026-001" style="width:100px;"></div>
            <div><strong>Date:</strong> <input type="text" id="inv-date"></div>
        </div>

        <table>
            <tr>
                <td width="15%"><strong>Company:</strong></td>
                <td width="45%"><input type="text" id="c-company" placeholder="Client's Company"></td>
                <td width="15%" align="center"><strong>Prepared by:</strong></td>
                <td width="25%"><input type="text" id="prep-by" value="Inovera Creation" style="text-align:center; font-weight:bold;"></td>
            </tr>
            <tr>
                <td><strong>Name:</strong></td>
                <td><input type="text" id="c-name" placeholder="Client Full Name"></td>
                <td align="center"><strong>Address:</strong></td>
                <td><input type="text" id="c-address" placeholder="Address"></td>
            </tr>
        </table>

        <table id="item-table">
            <thead>
                <tr><th width="5%">SL</th><th width="55%">Description</th><th width="10%">Qty</th><th width="15%">Price</th><th width="15%">Total</th></tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>

        <div style="margin-left: auto; width: 40%;">
            <table>
                <tr><td style="border:none; text-align:right;">Sub Total:</td><td><input type="number" id="sub-total" readonly></td></tr>
            </table>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDvydurLyXf5MvkmxxF2AAOeT7DJXfsAZo",
            authDomain: "bill-547bb.firebaseapp.com",
            databaseURL: "https://bill-547bb-default-rtdb.firebaseio.com",
            projectId: "bill-547bb",
            appId: "1:259028728782:web:de8abc7d1bdd3fbdb2899f"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // 1. Save to Firebase
        function saveInvoice() {
            const invNo = document.getElementById('inv-no').value;
            const data = {
                invNo: invNo,
                customer: document.getElementById('c-name').value,
                company: document.getElementById('c-company').value,
                total: document.getElementById('sub-total').value,
                date: document.getElementById('inv-date').value
            };

            database.ref('invoices/' + invNo.replace('.', '_')).set(data)
                .then(() => alert("অনলাইনে সেভ হয়েছে!"))
                .catch((e) => alert("ভুল: " + e.message));
        }

        // 2. Global Search from Firebase
        function globalSearch() {
            const q = document.getElementById('main-search').value.toLowerCase();
            const res = document.getElementById('search-results');
            if (!q) { res.innerHTML = ""; return; }

            database.ref('invoices').once('value').then((snapshot) => {
                const dbData = snapshot.val();
                let html = "";
                for (let id in dbData) {
                    const bill = dbData[id];
                    if (bill.invNo.toLowerCase().includes(q) || bill.customer.toLowerCase().includes(q)) {
                        html += `<div class="search-item" onclick="loadInv('${id}')">${bill.invNo} - ${bill.customer}</div>`;
                    }
                }
                res.innerHTML = html;
            });
        }

        // 3. Load from Firebase
        function loadInv(id) {
            database.ref('invoices/' + id).once('value').then((snapshot) => {
                const d = snapshot.val();
                if (d) {
                    document.getElementById('inv-no').value = d.invNo;
                    document.getElementById('c-name').value = d.customer;
                    document.getElementById('c-company').value = d.company || '';
                    document.getElementById('sub-total').value = d.total;
                    document.getElementById('inv-date').value = d.date;
                    document.getElementById('search-results').innerHTML = "";
                }
            });
        }

        // Common Functions
        function addRow() {
            const tbody = document.getElementById('tbody');
            const row = tbody.insertRow();
            row.innerHTML = `
                <td align="center">${tbody.rows.length}</td>
                <td><textarea oninput="calculate()"></textarea></td>
                <td><input type="number" class="qty" value="1" oninput="calculate()"></td>
                <td><input type="number" class="price" value="0" oninput="calculate()"></td>
                <td><input type="number" class="row-total" readonly></td>
            `;
        }

        function calculate() {
            let subTotal = 0;
            document.querySelectorAll('#tbody tr').forEach(row => {
                const q = row.querySelector('.qty').value || 0;
                const p = row.querySelector('.price').value || 0;
                const total = q * p;
                row.querySelector('.row-total').value = total.toFixed(2);
                subTotal += total;
            });
            document.getElementById('sub-total').value = subTotal.toFixed(2);
        }

        document.getElementById('inv-date').value = new Date().toLocaleDateString('en-GB');
        window.onload = addRow;
    </script>
</body>
</html>
